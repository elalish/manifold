class tt{constructor(){this._listeners={}}addEventListener(e,t){const s=this._listeners;return s[e]===void 0&&(s[e]=[]),s[e].indexOf(t)===-1&&s[e].push(t),this}removeEventListener(e,t){if(this._listeners===void 0)return this;const n=this._listeners[e];if(n!==void 0){const i=n.indexOf(t);i!==-1&&n.splice(i,1)}return this}dispatchEvent(e){if(this._listeners===void 0)return this;const s=this._listeners[e.type];if(s!==void 0){const n=s.slice(0);for(let i=0,o=n.length;i<o;i++)n[i].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class ce extends tt{constructor(e,t,s,n={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=s,this._attributes=n,!t.isOnGraph(s))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}}class Wt extends tt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){return this.listParentEdges(e).map(t=>t.getParent())}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){return this.listChildEdges(e).map(t=>t.getChild())}disconnectParents(e,t){let s=this.listParentEdges(e);return t&&(s=s.filter(n=>t(n.getParent()))),s.forEach(n=>n.dispose()),this}createEdge(e,t,s,n){return this._registerEdge(new ce(e,t,s,n))}_registerEdge(e){this._edges.add(e);const t=e.getParent();this._parentEdges.has(t)||this._parentEdges.set(t,new Set),this._parentEdges.get(t).add(e);const s=e.getChild();return this._childEdges.has(s)||this._childEdges.set(s,new Set),this._childEdges.get(s).add(e),e.addEventListener("dispose",()=>this._removeEdge(e)),e}_removeEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function pe(){return pe=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(r[s]=t[s])}return r},pe.apply(this,arguments)}function He(r){return r instanceof ce}function le(r){return Array.isArray(r)&&r[0]instanceof ce}function ge(r){return!!(Xt(r)&&Yt(r)instanceof ce)}function Yt(r){for(const e in r)return r[e]}function Xt(r){return!!r&&Object.getPrototypeOf(r)===Object.prototype}const L=Symbol("attributes"),ae=Symbol("immutableKeys");class st extends tt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[L]=void 0,this[ae]=void 0,this.graph=e,this[ae]=new Set,this[L]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const s in e){const n=e[s];if(n instanceof st){const i=this.graph.createEdge(s,this,n);i.addEventListener("dispose",()=>n.dispose()),this[ae].add(s),t[s]=i}else t[s]=n}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const s in this[L]){const n=this[L][s];if(He(n)){const i=n;i.getChild()===e&&this.setRef(s,t,i.getAttributes())}else if(le(n)){const o=n.find(c=>c.getChild()===e);if(o){const c=o.getAttributes();this.removeRef(s,e).addRef(s,t,c)}}else if(ge(n)){const i=n;for(const o in i){const c=i[o];c.getChild()===e&&this.setRefMap(s,o,t,c.getAttributes())}}}return this}get(e){return this[L][e]}set(e,t){return this[L][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[L][e];return t?t.getChild():null}setRef(e,t,s){if(this[ae].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const n=this[L][e];if(n&&n.dispose(),!t)return this;const i=this.graph.createEdge(e,this,t,s);return i.addEventListener("dispose",()=>{delete this[L][e],this.dispatchEvent({type:"change",attribute:e})}),this[L][e]=i,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this[L][e].map(s=>s.getChild())}addRef(e,t,s){const n=this.graph.createEdge(e,this,t,s),i=this[L][e];return i.push(n),n.addEventListener("dispose",()=>{const o=i.filter(c=>c!==n);i.length=0;for(const c of o)i.push(c);this.dispatchEvent({type:"change",attribute:e})}),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){return this[L][e].filter(i=>i.getChild()===t).forEach(i=>i.dispose()),this}listRefMapKeys(e){return Object.keys(this[L][e])}listRefMapValues(e){return Object.values(this[L][e]).map(t=>t.getChild())}getRefMap(e,t){const s=this[L][e];return s[t]?s[t].getChild():null}setRefMap(e,t,s,n){const i=this[L][e],o=i[t];if(o&&o.dispose(),!s)return this;n=Object.assign(n||{},{key:t});const c=this.graph.createEdge(e,this,s,pe({},n,{key:t}));return c.addEventListener("dispose",()=>{delete i[t],this.dispatchEvent({type:"change",attribute:e,key:t})}),i[t]=c,this.dispatchEvent({type:"change",attribute:e,key:t})}dispatchEvent(e){return super.dispatchEvent(pe({},e,{target:this})),this.graph.dispatchEvent(pe({},e,{target:this,type:`node:${e.type}`})),this}}const xt="v3.3.1",Le="@glb.bin";var x,De,$,Je,te;(function(r){r.ACCESSOR="Accessor",r.ANIMATION="Animation",r.ANIMATION_CHANNEL="AnimationChannel",r.ANIMATION_SAMPLER="AnimationSampler",r.BUFFER="Buffer",r.CAMERA="Camera",r.MATERIAL="Material",r.MESH="Mesh",r.PRIMITIVE="Primitive",r.PRIMITIVE_TARGET="PrimitiveTarget",r.NODE="Node",r.ROOT="Root",r.SCENE="Scene",r.SKIN="Skin",r.TEXTURE="Texture",r.TEXTURE_INFO="TextureInfo"})(x||(x={})),function(r){r.INTERLEAVED="interleaved",r.SEPARATE="separate"}(De||(De={})),function(r){r.ARRAY_BUFFER="ARRAY_BUFFER",r.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",r.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",r.OTHER="OTHER",r.SPARSE="SPARSE"}($||($={})),function(r){r[r.R=4096]="R",r[r.G=256]="G",r[r.B=16]="B",r[r.A=1]="A"}(Je||(Je={})),function(r){r.GLTF="GLTF",r.GLB="GLB"}(te||(te={}));const Ue={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var be,Ze=typeof Float32Array<"u"?Float32Array:Array;function Xe(r){return Math.hypot(r[0],r[1],r[2])}function qt(r,e,t){var s=e[0],n=e[1],i=e[2],o=t[3]*s+t[7]*n+t[11]*i+t[15];return r[0]=(t[0]*s+t[4]*n+t[8]*i+t[12])/(o=o||1),r[1]=(t[1]*s+t[5]*n+t[9]*i+t[13])/o,r[2]=(t[2]*s+t[6]*n+t[10]*i+t[14])/o,r}function Cs(r){const e={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},t=r.propertyType===x.NODE?[r]:r.listChildren();for(const s of t)s.traverse(n=>{const i=n.getMesh();if(!i)return;const o=Ht(i,n.getWorldMatrix());Qe(o.min,e),Qe(o.max,e)});return e}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)}),be=new Ze(3),Ze!=Float32Array&&(be[0]=0,be[1]=0,be[2]=0);function Ht(r,e){const t={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const s of r.listPrimitives()){const n=s.getAttribute("POSITION");if(!n)continue;let i=[0,0,0],o=[0,0,0];for(let c=0;c<n.getCount();c++)i=n.getElement(c,i),o=qt(o,i,e),Qe(o,t)}return t}function Qe(r,e){for(let t=0;t<3;t++)e.min[t]=Math.min(r[t],e.min[t]),e.max[t]=Math.max(r[t],e.max[t])}class O{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),s=new Uint8Array(t.length);for(let n=0;n<t.length;n++)s[n]=t.charCodeAt(n);return s}{const t=e.split(",")[1],s=e.indexOf("base64")>=0;return Buffer.from(t,s?"base64":"utf8")}}static encodeText(e){return typeof TextEncoder<"u"?new TextEncoder().encode(e):Buffer.from(e)}static decodeText(e){return typeof TextDecoder<"u"?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}static concat(e){let t=0;for(const i of e)t+=i.byteLength;const s=new Uint8Array(t);let n=0;for(const i of e)s.set(i,n),n+=i.byteLength;return s}static pad(e,t=0){const s=this.padNumber(e.byteLength);if(s===e.byteLength)return e;const n=new Uint8Array(s);if(n.set(e),t!==0)for(let i=e.byteLength;i<s;i++)n[i]=t;return n}static padNumber(e){return 4*Math.ceil(e/4)}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let s=e.byteLength;for(;s--;)if(e[s]!==t[s])return!1;return!0}static toView(e,t=0,s=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,s))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class we{static hexToFactor(e,t){e=Math.floor(e);const s=t;return s[0]=(e>>16&255)/255,s[1]=(e>>8&255)/255,s[2]=(255&e)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[s,n,i]=this.convertLinearToSRGB(e,t);return 255*s<<16^255*n<<8^255*i<<0}static convertSRGBToLinear(e,t){const s=e,n=t;for(let i=0;i<3;i++)n[i]=s[i]<.04045?.0773993808*s[i]:Math.pow(.9478672986*s[i]+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const s=e,n=t;for(let i=0;i<3;i++)n[i]=s[i]<.0031308?12.92*s[i]:1.055*Math.pow(s[i],.41666)-.055;return t}}class ze{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return O.decodeText(e.slice(12,16))===ze.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}ze.PNG_FRIED_CHUNK_NAME="CgBI";class se{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let s=0;const n=this.getSize(e,t);if(!n)return null;for(;n[0]>1||n[1]>1;)s+=n[0]*n[1]*4,n[0]=Math.max(Math.floor(n[0]/2),1),n[1]=Math.max(Math.floor(n[1]/2),1);return s+=4,s}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}function Jt(r,e){if(e>r.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(r.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return r}se.impls={"image/jpeg":new class{match(r){return r.length>=3&&r[0]===255&&r[1]===216&&r[2]===255}getSize(r){let e,t,s=new DataView(r.buffer,r.byteOffset+4);for(;s.byteLength;){if(e=s.getUint16(0,!1),Jt(s,e),t=s.getUint8(e+1),t===192||t===193||t===194)return[s.getUint16(e+7,!1),s.getUint16(e+5,!1)];s=new DataView(r.buffer,s.byteOffset+e+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(r){return 3}},"image/png":new ze};class ue{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return se.mimeTypeToExtension(t)}return e.startsWith("data:model/gltf+json")?"gltf":e.startsWith("data:model/gltf-binary")?"glb":e.startsWith("data:application/")?"bin":e.split(/[\\/]/).pop().split(/[.]/).pop()}}function it(r){return Object.prototype.toString.call(r)==="[object Object]"}function ee(r){if(it(r)===!1)return!1;const e=r.constructor;if(e===void 0)return!0;const t=e.prototype;return it(t)!==!1&&Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")!==!1}var Ke;(function(r){r[r.SILENT=4]="SILENT",r[r.ERROR=3]="ERROR",r[r.WARN=2]="WARN",r[r.INFO=1]="INFO",r[r.DEBUG=0]="DEBUG"})(Ke||(Ke={}));class k{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=k.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=k.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=k.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=k.Verbosity.ERROR&&console.error(e)}}function Zt(r,e,t){var s=e[0],n=e[1],i=e[2],o=e[3],c=e[4],f=e[5],p=e[6],d=e[7],T=e[8],y=e[9],A=e[10],R=e[11],I=e[12],u=e[13],E=e[14],a=e[15],h=t[0],l=t[1],g=t[2],m=t[3];return r[0]=h*s+l*c+g*T+m*I,r[1]=h*n+l*f+g*y+m*u,r[2]=h*i+l*p+g*A+m*E,r[3]=h*o+l*d+g*R+m*a,r[4]=(h=t[4])*s+(l=t[5])*c+(g=t[6])*T+(m=t[7])*I,r[5]=h*n+l*f+g*y+m*u,r[6]=h*i+l*p+g*A+m*E,r[7]=h*o+l*d+g*R+m*a,r[8]=(h=t[8])*s+(l=t[9])*c+(g=t[10])*T+(m=t[11])*I,r[9]=h*n+l*f+g*y+m*u,r[10]=h*i+l*p+g*A+m*E,r[11]=h*o+l*d+g*R+m*a,r[12]=(h=t[12])*s+(l=t[13])*c+(g=t[14])*T+(m=t[15])*I,r[13]=h*n+l*f+g*y+m*u,r[14]=h*i+l*p+g*A+m*E,r[15]=h*o+l*d+g*R+m*a,r}k.Verbosity=Ke,k.DEFAULT_INSTANCE=new k(k.Verbosity.INFO);class U{static identity(e){return e}static eq(e,t,s=1e-5){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>s)return!1;return!0}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static denormalize(e,t){return U.decodeNormalizedInt(e,t)}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(65535*e);case 5121:return Math.round(255*e);case 5122:return Math.round(32767*e);case 5120:return Math.round(127*e);default:throw new Error("Invalid component type.")}}static normalize(e,t){return U.encodeNormalizedInt(e,t)}static decompose(e,t,s,n){let i=Xe([e[0],e[1],e[2]]);const o=Xe([e[4],e[5],e[6]]),c=Xe([e[8],e[9],e[10]]);var f,p,d,T,y,A,R,I,u,E,a,h,l,g,m,w,M;((p=(f=e)[0])*(R=f[5])-(d=f[1])*(A=f[4]))*((h=f[10])*(M=f[15])-(l=f[11])*(w=f[14]))-(p*(I=f[6])-(T=f[2])*A)*((a=f[9])*M-l*(m=f[13]))+(p*(u=f[7])-(y=f[3])*A)*(a*w-h*m)+(d*I-T*R)*((E=f[8])*M-l*(g=f[12]))-(d*u-y*R)*(E*w-h*g)+(T*u-y*I)*(E*m-a*g)<0&&(i=-i),t[0]=e[12],t[1]=e[13],t[2]=e[14];const S=e.slice(),P=1/i,v=1/o,D=1/c;S[0]*=P,S[1]*=P,S[2]*=P,S[4]*=v,S[5]*=v,S[6]*=v,S[8]*=D,S[9]*=D,S[10]*=D,function(N,C){var F=new Ze(3);(function(Ye,q){var _t=q[4],jt=q[5],Gt=q[6],zt=q[8],kt=q[9],$t=q[10];Ye[0]=Math.hypot(q[0],q[1],q[2]),Ye[1]=Math.hypot(_t,jt,Gt),Ye[2]=Math.hypot(zt,kt,$t)})(F,C);var _=1/F[0],V=1/F[1],Y=1/F[2],j=C[0]*_,Z=C[1]*V,ie=C[2]*Y,W=C[4]*_,Q=C[5]*V,K=C[6]*Y,Ae=C[8]*_,Ie=C[9]*V,oe=C[10]*Y,nt=j+Q+oe,B=0;nt>0?(B=2*Math.sqrt(nt+1),N[3]=.25*B,N[0]=(K-Ie)/B,N[1]=(Ae-ie)/B,N[2]=(Z-W)/B):j>Q&&j>oe?(B=2*Math.sqrt(1+j-Q-oe),N[3]=(K-Ie)/B,N[0]=.25*B,N[1]=(Z+W)/B,N[2]=(Ae+ie)/B):Q>oe?(B=2*Math.sqrt(1+Q-j-oe),N[3]=(Ae-ie)/B,N[0]=(Z+W)/B,N[1]=.25*B,N[2]=(K+Ie)/B):(B=2*Math.sqrt(1+oe-j-Q),N[3]=(Z-W)/B,N[0]=(Ae+ie)/B,N[1]=(K+Ie)/B,N[2]=.25*B)}(s,S),n[0]=i,n[1]=o,n[2]=c}static compose(e,t,s,n){const i=n,o=t[0],c=t[1],f=t[2],p=t[3],d=o+o,T=c+c,y=f+f,A=o*d,R=o*T,I=o*y,u=c*T,E=c*y,a=f*y,h=p*d,l=p*T,g=p*y,m=s[0],w=s[1],M=s[2];return i[0]=(1-(u+a))*m,i[1]=(R+g)*m,i[2]=(I-l)*m,i[3]=0,i[4]=(R-g)*w,i[5]=(1-(A+a))*w,i[6]=(E+h)*w,i[7]=0,i[8]=(I+l)*M,i[9]=(E-h)*M,i[10]=(1-(A+u))*M,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}}function Qt(r,e){if(!!r!=!!e)return!1;const t=r.getChild(),s=e.getChild();return t===s||t.equals(s)}function Kt(r,e){if(!!r!=!!e||r.length!==e.length)return!1;for(let t=0;t<r.length;t++){const s=r[t],n=e[t];if(s.getChild()!==n.getChild()&&!s.getChild().equals(n.getChild()))return!1}return!0}function es(r,e){if(!!r!=!!e)return!1;const t=Object.keys(r),s=Object.keys(e);if(t.length!==s.length)return!1;for(const n in r){const i=r[n],o=e[n];if(!!i!=!!o)return!1;const c=i.getChild(),f=o.getChild();if(c!==f&&!c.equals(f))return!1}return!0}function At(r,e){if(r===e)return!0;if(!!r!=!!e||!r||!e||r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function It(r,e){if(r===e)return!0;if(!!r!=!!e)return!1;if(!ee(r)||!ee(e))return r===e;const t=r,s=e;let n,i=0,o=0;for(n in t)i++;for(n in s)o++;if(i!==o)return!1;for(n in t){const c=t[n],f=s[n];if(Be(c)&&Be(f)){if(!At(c,f))return!1}else if(ee(c)&&ee(f)){if(!It(c,f))return!1}else if(c!==f)return!1}return!0}function Be(r){return Array.isArray(r)||ArrayBuffer.isView(r)}const ot=new Set,ts=function(){let r="";for(let e=0;e<6;e++)r+="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ".charAt(Math.floor(42*Math.random()));return r},ss=function(){for(let r=0;r<999;r++){const e=ts();if(!ot.has(e))return ot.add(e),e}return""},at="https://null.example";class de{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return ue.basename(new URL(e,at).pathname)}static extension(e){return ue.extension(new URL(e,at).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const s=e.split("/"),n=t.split("/");s.pop();for(let i=0;i<n.length;i++)n[i]!=="."&&(n[i]===".."?s.pop():s.push(n[i]));return s.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}de.DEFAULT_INIT={},de.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const J=r=>r,rs=new Set;class rt extends st{constructor(e,t=""){super(e),this[L].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){return new this.constructor(this.graph).copy(this,J)}copy(e,t=J){for(const s in this[L]){const n=this[L][s];if(n instanceof ce)this[ae].has(s)||n.dispose();else if(le(n))for(const i of n)i.dispose();else if(ge(n))for(const i in n)n[i].dispose()}for(const s in e[L]){const n=this[L][s],i=e[L][s];if(i instanceof ce)this[ae].has(s)?n.getChild().copy(t(i.getChild()),t):this.setRef(s,t(i.getChild()),i.getAttributes());else if(le(i))for(const o of i)this.addRef(s,t(o.getChild()),o.getAttributes());else if(ge(i))for(const o in i){const c=i[o];this.setRefMap(s,o,t(c.getChild()),c.getAttributes())}else this[L][s]=ee(i)?JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.slice():i}return this}equals(e,t=rs){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const s in this[L]){if(t.has(s))continue;const n=this[L][s],i=e[L][s];if(He(n)||He(i)){if(!Qt(n,i))return!1}else if(le(n)||le(i)){if(!Kt(n,i))return!1}else if(ge(n)||ge(i)){if(!es(n,i))return!1}else if(ee(n)||ee(i)){if(!It(n,i))return!1}else if(Be(n)||Be(i)){if(!At(n,i))return!1}else if(n!==i)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}let z=class extends rt{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t.t(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}};class b extends z{constructor(...e){super(...e),this.i=U.identity,this.o=U.identity}init(){this.propertyType=x.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:b.Type.SCALAR,componentType:b.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}copy(e,t=J){return super.copy(e,t),this.i=e.i,this.o=e.o,this}static getElementSize(e){switch(e){case b.Type.SCALAR:return 1;case b.Type.VEC2:return 2;case b.Type.VEC3:return 3;case b.Type.VEC4:case b.Type.MAT2:return 4;case b.Type.MAT3:return 9;case b.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case b.ComponentType.BYTE:case b.ComponentType.UNSIGNED_BYTE:return 1;case b.ComponentType.SHORT:case b.ComponentType.UNSIGNED_SHORT:return 2;case b.ComponentType.UNSIGNED_INT:case b.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getElementSize();this.getMin(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMin(e){const t=this.get("array"),s=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=1/0;for(let i=0;i<s*n;i+=n)for(let o=0;o<n;o++){const c=t[i+o];Number.isFinite(c)&&(e[o]=Math.min(e[o],c))}return e}getMaxNormalized(e){const t=this.getElementSize();this.getMax(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMax(e){const t=this.get("array"),s=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=-1/0;for(let i=0;i<s*n;i+=n)for(let o=0;o<n;o++){const c=t[i+o];Number.isFinite(c)&&(e[o]=Math.max(e[o],c))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return b.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e),e?(this.o=t=>U.decodeNormalizedInt(t,this.get("componentType")),this.i=t=>U.encodeNormalizedInt(t,this.get("componentType"))):(this.o=U.identity,this.i=U.identity),this}getScalar(e){const t=this.getElementSize();return this.o(this.get("array")[e*t])}setScalar(e,t){return this.get("array")[e*this.getElementSize()]=this.i(t),this}getElement(e,t){const s=this.getElementSize(),n=this.get("array");for(let i=0;i<s;i++)t[i]=this.o(n[e*s+i]);return t}setElement(e,t){const s=this.getElementSize(),n=this.get("array");for(let i=0;i<s;i++)n[e*s+i]=this.i(t[i]);return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?function(t){switch(t.constructor){case Float32Array:return b.ComponentType.FLOAT;case Uint32Array:return b.ComponentType.UNSIGNED_INT;case Uint16Array:return b.ComponentType.UNSIGNED_SHORT;case Uint8Array:return b.ComponentType.UNSIGNED_BYTE;case Int16Array:return b.ComponentType.SHORT;case Int8Array:return b.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(e):b.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}b.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},b.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};class bt extends z{init(){this.propertyType=x.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}let ke=class extends z{init(){this.propertyType=x.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}};ke.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class ye extends z{init(){this.propertyType=x.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:ye.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:$.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:$.OTHER})}}ye.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class wt extends z{init(){this.propertyType=x.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}let Te=class Mt extends z{init(){this.propertyType=x.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Mt.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}};Te.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class Re extends rt{t(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}Re.EXTENSION_NAME=void 0;let X=class et extends z{init(){this.propertyType=x.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:et.WrapMode.REPEAT,wrapT:et.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}};X.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},X.MagFilter={NEAREST:9728,LINEAR:9729},X.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:Me,G:Se,B:ve,A:ns}=Je;class ne extends z{init(){this.propertyType=x.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:ne.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new X(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new X(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new X(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new X(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new X(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorHex(){return we.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(e){const t=this.get("baseColorFactor").slice();return this.set("baseColorFactor",we.hexToFactor(e,t))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:Me|Se|ve|ns,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveHex(){return we.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(e){const t=this.get("emissiveFactor").slice();return this.set("emissiveFactor",we.hexToFactor(e,t))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:Me|Se|ve,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:Me|Se|ve})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:Me})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:Se|ve})}}ne.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};let St=class extends z{init(){this.propertyType=x.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}},vt=class extends z{constructor(...e){super(...e),this.u=null}init(){this.propertyType=x.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(e,t=J){if(t===J)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return U.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),s=this.get("rotation").slice(),n=this.get("scale").slice();return U.decompose(e,t,s,n),this.set("translation",t).set("rotation",s).set("scale",n)}getWorldTranslation(){const e=[0,0,0];return U.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return U.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return U.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let n=this;n!=null;n=n.u)e.push(n);let t;const s=e.pop().getMatrix();for(;t=e.pop();)Zt(s,s,t.getMatrix());return s}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.u=this;const t=this[L].children;return t[t.length-1].addEventListener("dispose",()=>e.u=null),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParent(){return this.u?this.u:this.listParents().find(e=>e.propertyType===x.SCENE)||null}getParentNode(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}};class xe extends z{init(){this.propertyType=x.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:xe.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:$.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:$.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}xe.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};let Nt=class extends rt{init(){this.propertyType=x.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:$.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}};function G(){return G=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(r[s]=t[s])}return r},G.apply(this,arguments)}let $e=class extends z{init(){this.propertyType=x.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(e,t=J){if(t===J)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}},Ct=class extends z{init(){this.propertyType=x.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:$.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}};class Ee extends z{init(){this.propertyType=x.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||se.extensionToMimeType(ue.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=se.extensionToMimeType(ue.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",O.assertView(e))}getSize(){const e=this.get("image");return e?se.getSize(e,this.getMimeType()):null}}let Ot=class extends z{init(){this.propertyType=x.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${xt}`,version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(e){super(e),this.h=new Set,e.addEventListener("node:create",t=>{this.l(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=J){if(t===J)throw new Error("Root cannot be copied.");this.set("asset",G({},e.get("asset"))),this.setName(e.getName()),this.setExtras(G({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const s of e.listRefMapKeys("extensions")){const n=e.getExtension(s);this.setExtension(s,t(n))}return this}l(e){return e instanceof $e?this.addRef("scenes",e):e instanceof vt?this.addRef("nodes",e):e instanceof Te?this.addRef("cameras",e):e instanceof Ct?this.addRef("skins",e):e instanceof St?this.addRef("meshes",e):e instanceof ne?this.addRef("materials",e):e instanceof Ee?this.addRef("textures",e):e instanceof bt?this.addRef("animations",e):e instanceof b?this.addRef("accessors",e):e instanceof wt&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.h)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}g(e){return this.h.add(e),this}p(e){return this.h.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}},Pt=class Fe{static fromGraph(e){return Fe.m.get(e)||null}constructor(){this.v=new Wt,this.T=new Ot(this.v),this.M=k.DEFAULT_INSTANCE,Fe.m.set(this.v,this)}getRoot(){return this.T}getGraph(){return this.v}getLogger(){return this.M}setLogger(e){return this.M=e,this}clone(){return new Fe().setLogger(this.M).merge(this)}merge(e){for(const i of e.getRoot().listExtensionsUsed()){const o=this.createExtension(i.constructor);i.isRequired()&&o.setRequired(!0)}const t=new Set,s=new Map;t.add(e.T),s.set(e.T,this.T);for(const i of e.v.listEdges())for(const o of[i.getParent(),i.getChild()]){if(t.has(o))continue;let c;c=o.propertyType===x.TEXTURE_INFO?o:new o.constructor(this.v),s.set(o,c),t.add(o)}const n=i=>{const o=s.get(i);if(!o)throw new Error("Could resolve property.");return o};for(const i of t){const o=s.get(i);if(!o)throw new Error("Could resolve property.");o.propertyType!==x.TEXTURE_INFO&&o.copy(i,n)}return this}async transform(...e){const t=e.map(s=>s.name);for(const s of e)await s(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(s=>s.extensionName===t)||new e(this)}createScene(e=""){return new $e(this.v,e)}createNode(e=""){return new vt(this.v,e)}createCamera(e=""){return new Te(this.v,e)}createSkin(e=""){return new Ct(this.v,e)}createMesh(e=""){return new St(this.v,e)}createPrimitive(){return new xe(this.v)}createPrimitiveTarget(e=""){return new Nt(this.v,e)}createMaterial(e=""){return new ne(this.v,e)}createTexture(e=""){return new Ee(this.v,e)}createAnimation(e=""){return new bt(this.v,e)}createAnimationChannel(e=""){return new ke(this.v,e)}createAnimationSampler(e=""){return new ye(this.v,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new b(this.v,e).setBuffer(t)}createBuffer(e=""){return new wt(this.v,e)}};Pt.m=new WeakMap;let Ft=class{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.S=void 0,this.document=e,e.getRoot().g(this),this.S=s=>{const n=s,i=n.target;i instanceof Re&&i.extensionName===this.extensionName&&(n.type==="node:create"&&this.I(i),n.type==="node:dispose"&&this.N(i))};const t=e.getGraph();t.addEventListener("node:create",this.S),t.addEventListener("node:dispose",this.S)}dispose(){this.document.getRoot().p(this);const e=this.document.getGraph();e.removeEventListener("node:create",this.S),e.removeEventListener("node:dispose",this.S);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}I(e){return this.properties.add(e),this}N(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}};Ft.EXTENSION_NAME=void 0;class is{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const s=this.jsonDoc.json.textures[t.index];if(s.sampler===void 0)return;const n=this.jsonDoc.json.samplers[s.sampler];n.magFilter!==void 0&&e.setMagFilter(n.magFilter),n.minFilter!==void 0&&e.setMinFilter(n.minFilter),n.wrapS!==void 0&&e.setWrapS(n.wrapS),n.wrapT!==void 0&&e.setWrapT(n.wrapT)}}const ct={logger:k.DEFAULT_INSTANCE,extensions:[],dependencies:{}};let os=class{static read(e,t=ct){const s=G({},ct,t),{json:n}=e,i=new Pt().setLogger(s.logger);this.validate(e,s);const o=new is(e),c=n.asset,f=i.getRoot().getAsset();c.copyright&&(f.copyright=c.copyright),c.extras&&(f.extras=c.extras),n.extras!==void 0&&i.getRoot().setExtras(G({},n.extras));const p=n.extensionsUsed||[],d=n.extensionsRequired||[];for(const a of s.extensions)if(p.includes(a.EXTENSION_NAME)){const h=i.createExtension(a).setRequired(d.includes(a.EXTENSION_NAME));for(const l of h.readDependencies)h.install(l,s.dependencies[l])}const T=n.buffers||[];i.getRoot().listExtensionsUsed().filter(a=>a.prereadTypes.includes(x.BUFFER)).forEach(a=>a.preread(o,x.BUFFER)),o.buffers=T.map(a=>{const h=i.createBuffer(a.name);return a.extras&&h.setExtras(a.extras),a.uri&&a.uri.indexOf("__")!==0&&h.setURI(a.uri),h}),o.bufferViewBuffers=(n.bufferViews||[]).map((a,h)=>{if(!o.bufferViews[h]){const l=e.json.buffers[a.buffer];o.bufferViews[h]=O.toView(l.uri?e.resources[l.uri]:e.resources[Le],a.byteOffset||0,a.byteLength)}return o.buffers[a.buffer]});const y=n.accessors||[];o.accessors=y.map(a=>{const h=i.createAccessor(a.name,o.bufferViewBuffers[a.bufferView]).setType(a.type);return a.extras&&h.setExtras(a.extras),a.normalized!==void 0&&h.setNormalized(a.normalized),a.bufferView===void 0||h.setArray(Ne(a,o)),h});const A=n.images||[],R=n.textures||[];i.getRoot().listExtensionsUsed().filter(a=>a.prereadTypes.includes(x.TEXTURE)).forEach(a=>a.preread(o,x.TEXTURE)),o.textures=A.map(a=>{const h=i.createTexture(a.name);if(a.extras&&h.setExtras(a.extras),a.bufferView!==void 0){const l=n.bufferViews[a.bufferView],g=e.json.buffers[l.buffer],m=l.byteOffset||0,w=(g.uri?e.resources[g.uri]:e.resources[Le]).slice(m,m+l.byteLength);h.setImage(w)}else a.uri!==void 0&&(h.setImage(e.resources[a.uri]),a.uri.indexOf("__")!==0&&h.setURI(a.uri));if(a.mimeType!==void 0)h.setMimeType(a.mimeType);else if(a.uri){const l=ue.extension(a.uri);h.setMimeType(se.extensionToMimeType(l))}return h}),o.materials=(n.materials||[]).map(a=>{const h=i.createMaterial(a.name);a.extras&&h.setExtras(a.extras),a.alphaMode!==void 0&&h.setAlphaMode(a.alphaMode),a.alphaCutoff!==void 0&&h.setAlphaCutoff(a.alphaCutoff),a.doubleSided!==void 0&&h.setDoubleSided(a.doubleSided);const l=a.pbrMetallicRoughness||{};if(l.baseColorFactor!==void 0&&h.setBaseColorFactor(l.baseColorFactor),a.emissiveFactor!==void 0&&h.setEmissiveFactor(a.emissiveFactor),l.metallicFactor!==void 0&&h.setMetallicFactor(l.metallicFactor),l.roughnessFactor!==void 0&&h.setRoughnessFactor(l.roughnessFactor),l.baseColorTexture!==void 0){const g=l.baseColorTexture;h.setBaseColorTexture(o.textures[R[g.index].source]),o.setTextureInfo(h.getBaseColorTextureInfo(),g)}if(a.emissiveTexture!==void 0){const g=a.emissiveTexture;h.setEmissiveTexture(o.textures[R[g.index].source]),o.setTextureInfo(h.getEmissiveTextureInfo(),g)}if(a.normalTexture!==void 0){const g=a.normalTexture;h.setNormalTexture(o.textures[R[g.index].source]),o.setTextureInfo(h.getNormalTextureInfo(),g),a.normalTexture.scale!==void 0&&h.setNormalScale(a.normalTexture.scale)}if(a.occlusionTexture!==void 0){const g=a.occlusionTexture;h.setOcclusionTexture(o.textures[R[g.index].source]),o.setTextureInfo(h.getOcclusionTextureInfo(),g),a.occlusionTexture.strength!==void 0&&h.setOcclusionStrength(a.occlusionTexture.strength)}if(l.metallicRoughnessTexture!==void 0){const g=l.metallicRoughnessTexture;h.setMetallicRoughnessTexture(o.textures[R[g.index].source]),o.setTextureInfo(h.getMetallicRoughnessTextureInfo(),g)}return h});const I=n.meshes||[];i.getRoot().listExtensionsUsed().filter(a=>a.prereadTypes.includes(x.PRIMITIVE)).forEach(a=>a.preread(o,x.PRIMITIVE)),o.meshes=I.map(a=>{const h=i.createMesh(a.name);return a.extras&&h.setExtras(a.extras),a.weights!==void 0&&h.setWeights(a.weights),(a.primitives||[]).forEach(l=>{const g=i.createPrimitive();l.extras&&g.setExtras(l.extras),l.material!==void 0&&g.setMaterial(o.materials[l.material]),l.mode!==void 0&&g.setMode(l.mode);for(const[w,M]of Object.entries(l.attributes||{}))g.setAttribute(w,o.accessors[M]);l.indices!==void 0&&g.setIndices(o.accessors[l.indices]);const m=a.extras&&a.extras.targetNames||[];(l.targets||[]).forEach((w,M)=>{const S=m[M]||M.toString(),P=i.createPrimitiveTarget(S);for(const[v,D]of Object.entries(w))P.setAttribute(v,o.accessors[D]);g.addTarget(P)}),h.addPrimitive(g)}),h}),o.cameras=(n.cameras||[]).map(a=>{const h=i.createCamera(a.name).setType(a.type);if(a.extras&&h.setExtras(a.extras),a.type===Te.Type.PERSPECTIVE){const l=a.perspective;h.setYFov(l.yfov),h.setZNear(l.znear),l.zfar!==void 0&&h.setZFar(l.zfar),l.aspectRatio!==void 0&&h.setAspectRatio(l.aspectRatio)}else{const l=a.orthographic;h.setZNear(l.znear).setZFar(l.zfar).setXMag(l.xmag).setYMag(l.ymag)}return h});const u=n.nodes||[];i.getRoot().listExtensionsUsed().filter(a=>a.prereadTypes.includes(x.NODE)).forEach(a=>a.preread(o,x.NODE)),o.nodes=u.map(a=>{const h=i.createNode(a.name);if(a.extras&&h.setExtras(a.extras),a.translation!==void 0&&h.setTranslation(a.translation),a.rotation!==void 0&&h.setRotation(a.rotation),a.scale!==void 0&&h.setScale(a.scale),a.matrix!==void 0){const l=[0,0,0],g=[0,0,0,1],m=[1,1,1];U.decompose(a.matrix,l,g,m),h.setTranslation(l),h.setRotation(g),h.setScale(m)}return a.weights!==void 0&&h.setWeights(a.weights),h}),o.skins=(n.skins||[]).map(a=>{const h=i.createSkin(a.name);a.extras&&h.setExtras(a.extras),a.inverseBindMatrices!==void 0&&h.setInverseBindMatrices(o.accessors[a.inverseBindMatrices]),a.skeleton!==void 0&&h.setSkeleton(o.nodes[a.skeleton]);for(const l of a.joints)h.addJoint(o.nodes[l]);return h}),u.map((a,h)=>{const l=o.nodes[h];(a.children||[]).forEach(g=>l.addChild(o.nodes[g])),a.mesh!==void 0&&l.setMesh(o.meshes[a.mesh]),a.camera!==void 0&&l.setCamera(o.cameras[a.camera]),a.skin!==void 0&&l.setSkin(o.skins[a.skin])}),o.animations=(n.animations||[]).map(a=>{const h=i.createAnimation(a.name);a.extras&&h.setExtras(a.extras);const l=(a.samplers||[]).map(g=>{const m=i.createAnimationSampler().setInput(o.accessors[g.input]).setOutput(o.accessors[g.output]).setInterpolation(g.interpolation||ye.Interpolation.LINEAR);return g.extras&&m.setExtras(g.extras),h.addSampler(m),m});return(a.channels||[]).forEach(g=>{const m=i.createAnimationChannel().setSampler(l[g.sampler]).setTargetPath(g.target.path);g.target.node!==void 0&&m.setTargetNode(o.nodes[g.target.node]),g.extras&&m.setExtras(g.extras),h.addChannel(m)}),h});const E=n.scenes||[];return i.getRoot().listExtensionsUsed().filter(a=>a.prereadTypes.includes(x.SCENE)).forEach(a=>a.preread(o,x.SCENE)),o.scenes=E.map(a=>{const h=i.createScene(a.name);return a.extras&&h.setExtras(a.extras),(a.nodes||[]).map(l=>o.nodes[l]).forEach(l=>h.addChild(l)),h}),n.scene!==void 0&&i.getRoot().setDefaultScene(o.scenes[n.scene]),i.getRoot().listExtensionsUsed().forEach(a=>a.read(o)),y.forEach((a,h)=>{const l=o.accessors[h],g=!!a.sparse,m=!a.bufferView&&!l.getArray();(g||m)&&l.setSparse(!0).setArray(function(w,M){const S=Ue[w.componentType],P=b.getElementSize(w.type);let v;v=w.bufferView!==void 0?Ne(w,M):new S(w.count*P);const D=w.sparse;if(!D)return v;const N=D.count,C=G({},w,D.indices,{count:N,type:"SCALAR"}),F=G({},w,D.values,{count:N}),_=Ne(C,M),V=Ne(F,M);for(let Y=0;Y<C.count;Y++)for(let j=0;j<P;j++)v[_[Y]*P+j]=V[Y*P+j];return v}(a,o))}),i}static validate(e,t){const s=e.json;if(s.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${s.asset.version}".`);if(s.extensionsRequired){for(const n of s.extensionsRequired)if(!t.extensions.find(i=>i.EXTENSION_NAME===n))throw new Error(`Missing required extension, "${n}".`)}if(s.extensionsUsed)for(const n of s.extensionsUsed)t.extensions.find(i=>i.EXTENSION_NAME===n)||t.logger.warn(`Missing optional extension, "${n}".`)}};function Ne(r,e){const t=e.bufferViews[r.bufferView],s=e.jsonDoc.json.bufferViews[r.bufferView],n=Ue[r.componentType],i=b.getElementSize(r.type),o=n.BYTES_PER_ELEMENT;if(s.byteStride!==void 0&&s.byteStride!==i*o)return function(f,p){const d=p.bufferViews[f.bufferView],T=p.jsonDoc.json.bufferViews[f.bufferView],y=Ue[f.componentType],A=b.getElementSize(f.type),R=y.BYTES_PER_ELEMENT,I=f.byteOffset||0,u=new y(f.count*A),E=new DataView(d.buffer,d.byteOffset,d.byteLength),a=T.byteStride;for(let h=0;h<f.count;h++)for(let l=0;l<A;l++){const g=I+h*a+l*R;let m;switch(f.componentType){case b.ComponentType.FLOAT:m=E.getFloat32(g,!0);break;case b.ComponentType.UNSIGNED_INT:m=E.getUint32(g,!0);break;case b.ComponentType.UNSIGNED_SHORT:m=E.getUint16(g,!0);break;case b.ComponentType.UNSIGNED_BYTE:m=E.getUint8(g);break;case b.ComponentType.SHORT:m=E.getInt16(g,!0);break;case b.ComponentType.BYTE:m=E.getInt8(g);break;default:throw new Error(`Unexpected componentType "${f.componentType}".`)}u[h*A+l]=m}return u}(r,e);const c=t.byteOffset+(r.byteOffset||0);return new n(t.buffer.slice(c,c+r.count*i*o))}var me;(function(r){r[r.ARRAY_BUFFER=34962]="ARRAY_BUFFER",r[r.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(me||(me={}));let re=class{constructor(e,t,s){this.O=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.C=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.O=e,this.jsonDoc=t,this.options=s;const n=e.getRoot(),i=n.listBuffers().length,o=n.listTextures().length;this.bufferURIGenerator=new ut(i>1,()=>s.basename||"buffer"),this.imageURIGenerator=new ut(o>1,c=>function(f,p){const d=f.getGraph().listParentEdges(p).find(T=>T.getParent()!==f.getRoot());return d?d.getName().replace(/texture$/i,""):""}(e,c)||s.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const s={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},n=JSON.stringify(s);this.samplerDefIndexMap.has(n)||(this.samplerDefIndexMap.set(n,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(s));const i={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(n)},o=JSON.stringify(i);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(i));const c={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(c.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(c.extras=t.getExtras()),this.textureInfoDefMap.set(t,c),c}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this.O.getGraph().listParentEdges(e).some(s=>s.getName()==="attributes"&&s.getAttributes().key==="POSITION"||s.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,s){if(this.options.format===te.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const n=se.mimeTypeToExtension(s.getMimeType());e.uri=this.imageURIGenerator.createURI(s,n),this.jsonDoc.resources[e.uri]=t}}getAccessorUsage(e){const t=this.C.get(e);if(t)return t;if(e.getSparse())return $.SPARSE;for(const s of this.O.getGraph().listParentEdges(e)){const{usage:n}=s.getAttributes();if(n)return n;s.getParent().propertyType!==x.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${s.getName()}".`)}return $.OTHER}addAccessorToUsageGroup(e,t){const s=this.C.get(e);if(s&&s!==t)throw new Error(`Accessor with usage "${s}" cannot be reused as "${t}".`);return this.C.set(e,t),this}listAccessorUsageGroups(){const e={};for(const[t,s]of Array.from(this.C.entries()))e[s]=e[s]||[],e[s].push(t);return e}};re.BufferViewTarget=me,re.BufferViewUsage=$,re.USAGE_TO_TARGET={[$.ARRAY_BUFFER]:me.ARRAY_BUFFER,[$.ELEMENT_ARRAY_BUFFER]:me.ELEMENT_ARRAY_BUFFER};class ut{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const s=this.basename(e);return this.counter[s]=this.counter[s]||1,`${s}_${this.counter[s]++}.${t}`}return`${this.basename(e)}.${t}`}}const{BufferViewUsage:Ce}=re,{UNSIGNED_INT:as,UNSIGNED_SHORT:cs,UNSIGNED_BYTE:us}=b.ComponentType;let fs=class{static write(e,t){const s=e.getRoot(),n={asset:G({generator:`glTF-Transform ${xt}`},s.getAsset()),extras:G({},s.getExtras())},i={json:n,resources:{}},o=new re(e,i,t),c=t.logger||k.DEFAULT_INSTANCE,f=new Set(t.extensions.map(u=>u.EXTENSION_NAME)),p=e.getRoot().listExtensionsUsed().filter(u=>f.has(u.extensionName)),d=e.getRoot().listExtensionsRequired().filter(u=>f.has(u.extensionName));p.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const u of p)for(const E of u.writeDependencies)u.install(E,t.dependencies[E]);function T(u,E,a,h){const l=[];let g=0;for(const w of u){const M=o.createAccessorDef(w);M.bufferView=n.bufferViews.length;const S=w.getArray(),P=O.pad(O.toView(S));M.byteOffset=g,g+=P.byteLength,l.push(P),o.accessorIndexMap.set(w,n.accessors.length),n.accessors.push(M)}const m={buffer:E,byteOffset:a,byteLength:O.concat(l).byteLength};return h&&(m.target=h),n.bufferViews.push(m),{buffers:l,byteLength:g}}function y(u,E,a){const h=u[0].getCount();let l=0;for(const M of u){const S=o.createAccessorDef(M);S.bufferView=n.bufferViews.length,S.byteOffset=l;const P=M.getElementSize(),v=M.getComponentSize();l+=O.padNumber(P*v),o.accessorIndexMap.set(M,n.accessors.length),n.accessors.push(S)}const g=h*l,m=new ArrayBuffer(g),w=new DataView(m);for(let M=0;M<h;M++){let S=0;for(const P of u){const v=P.getElementSize(),D=P.getComponentSize(),N=P.getComponentType(),C=P.getArray();for(let F=0;F<v;F++){const _=M*l+S+F*D,V=C[M*v+F];switch(N){case b.ComponentType.FLOAT:w.setFloat32(_,V,!0);break;case b.ComponentType.BYTE:w.setInt8(_,V);break;case b.ComponentType.SHORT:w.setInt16(_,V,!0);break;case b.ComponentType.UNSIGNED_BYTE:w.setUint8(_,V);break;case b.ComponentType.UNSIGNED_SHORT:w.setUint16(_,V,!0);break;case b.ComponentType.UNSIGNED_INT:w.setUint32(_,V,!0);break;default:throw new Error("Unexpected component type: "+N)}}S+=O.padNumber(v*D)}}return n.bufferViews.push({buffer:E,byteOffset:a,byteLength:g,byteStride:l,target:re.BufferViewTarget.ARRAY_BUFFER}),{byteLength:g,buffers:[new Uint8Array(m)]}}function A(u,E,a){const h=[];let l=0;const g=new Map;let m=-1/0;for(const N of u){const C=o.createAccessorDef(N);n.accessors.push(C),o.accessorIndexMap.set(N,n.accessors.length-1);const F=[],_=[],V=[],Y=new Array(N.getElementSize()).fill(0);for(let W=0,Q=N.getCount();W<Q;W++)if(N.getElement(W,V),!U.eq(V,Y,0)){m=Math.max(W,m),F.push(W);for(let K=0;K<V.length;K++)_.push(V[K])}const j=F.length,Z={accessorDef:C,count:j};if(g.set(N,Z),j===0)continue;if(j>N.getCount()/3){const W=(100*F.length/N.getCount()).toFixed(1);c.warn(`Sparse accessor with many non-zero elements (${W}%) may increase file size.`)}const ie=Ue[N.getComponentType()];Z.indices=F,Z.values=new ie(_)}if(!Number.isFinite(m))return{buffers:h,byteLength:l};const w=m<255?Uint8Array:m<65535?Uint16Array:Uint32Array,M=m<255?us:m<65535?cs:as,S={buffer:E,byteOffset:a+l,byteLength:0};for(const N of u){const C=g.get(N);if(C.count===0)continue;C.indicesByteOffset=S.byteLength;const F=O.pad(O.toView(new w(C.indices)));h.push(F),l+=F.byteLength,S.byteLength+=F.byteLength}n.bufferViews.push(S);const P=n.bufferViews.length-1,v={buffer:E,byteOffset:a+l,byteLength:0};for(const N of u){const C=g.get(N);if(C.count===0)continue;C.valuesByteOffset=v.byteLength;const F=O.pad(O.toView(C.values));h.push(F),l+=F.byteLength,v.byteLength+=F.byteLength}n.bufferViews.push(v);const D=n.bufferViews.length-1;for(const N of u){const C=g.get(N);C.count!==0&&(C.accessorDef.sparse={count:C.count,indices:{bufferView:P,byteOffset:C.indicesByteOffset,componentType:M},values:{bufferView:D,byteOffset:C.valuesByteOffset}})}return{buffers:h,byteLength:l}}const R=new Map;for(const u of e.getGraph().listEdges()){if(u.getParent()===s)continue;const E=u.getChild();if(E instanceof b){const a=R.get(E)||[];a.push(u),R.set(E,a)}}if(n.accessors=[],n.bufferViews=[],n.samplers=[],n.textures=[],n.images=s.listTextures().map((u,E)=>{const a=o.createPropertyDef(u);u.getMimeType()&&(a.mimeType=u.getMimeType());const h=u.getImage();return h&&o.createImageData(a,h,u),o.imageIndexMap.set(u,E),a}),p.filter(u=>u.prewriteTypes.includes(x.ACCESSOR)).forEach(u=>u.prewrite(o,x.ACCESSOR)),s.listAccessors().forEach(u=>{const E=o.accessorUsageGroupedByParent,a=o.accessorParents;if(o.accessorIndexMap.has(u))return;const h=R.get(u)||[],l=o.getAccessorUsage(u);if(o.addAccessorToUsageGroup(u,l),E.has(l)){const g=h[0].getParent(),m=a.get(g)||new Set;m.add(u),a.set(g,m)}}),p.filter(u=>u.prewriteTypes.includes(x.BUFFER)).forEach(u=>u.prewrite(o,x.BUFFER)),(s.listAccessors().length>0||s.listTextures().length>0||o.otherBufferViews.size>0)&&s.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");n.buffers=[],s.listBuffers().forEach((u,E)=>{const a=o.createPropertyDef(u),h=o.accessorUsageGroupedByParent,l=o.accessorParents,g=u.listParents().filter(v=>v instanceof b),m=new Set(g),w=[],M=n.buffers.length;let S=0;const P=o.listAccessorUsageGroups();for(const v in P)if(h.has(v))for(const D of Array.from(l.values())){const N=Array.from(D).filter(C=>m.has(C)).filter(C=>o.getAccessorUsage(C)===v);if(N.length)if(v!==Ce.ARRAY_BUFFER||t.vertexLayout===De.INTERLEAVED){const C=v===Ce.ARRAY_BUFFER?y(N,M,S):T(N,M,S);S+=C.byteLength,w.push(...C.buffers)}else for(const C of N){const F=y([C],M,S);S+=F.byteLength,w.push(...F.buffers)}}else{const D=P[v].filter(F=>m.has(F));if(!D.length)continue;const N=v===Ce.ELEMENT_ARRAY_BUFFER?re.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0,C=v===Ce.SPARSE?A(D,M,S):T(D,M,S,N);S+=C.byteLength,w.push(...C.buffers)}if(o.imageBufferViews.length&&E===0){for(let v=0;v<o.imageBufferViews.length;v++)if(n.bufferViews[n.images[v].bufferView].byteOffset=S,S+=o.imageBufferViews[v].byteLength,w.push(o.imageBufferViews[v]),S%8){const D=8-S%8;S+=D,w.push(new Uint8Array(D))}}if(o.otherBufferViews.has(u))for(const v of o.otherBufferViews.get(u))n.bufferViews.push({buffer:M,byteOffset:S,byteLength:v.byteLength}),o.otherBufferViewsIndexMap.set(v,n.bufferViews.length-1),S+=v.byteLength,w.push(v);if(S){let v;t.format===te.GLB?v=Le:(v=o.bufferURIGenerator.createURI(u,"bin"),a.uri=v),a.byteLength=S,i.resources[v]=O.concat(w)}n.buffers.push(a),o.bufferIndexMap.set(u,E)}),s.listAccessors().find(u=>!u.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),n.materials=s.listMaterials().map((u,E)=>{const a=o.createPropertyDef(u);if(u.getAlphaMode()!==ne.AlphaMode.OPAQUE&&(a.alphaMode=u.getAlphaMode()),u.getAlphaMode()===ne.AlphaMode.MASK&&(a.alphaCutoff=u.getAlphaCutoff()),u.getDoubleSided()&&(a.doubleSided=!0),a.pbrMetallicRoughness={},U.eq(u.getBaseColorFactor(),[1,1,1,1])||(a.pbrMetallicRoughness.baseColorFactor=u.getBaseColorFactor()),U.eq(u.getEmissiveFactor(),[0,0,0])||(a.emissiveFactor=u.getEmissiveFactor()),u.getRoughnessFactor()!==1&&(a.pbrMetallicRoughness.roughnessFactor=u.getRoughnessFactor()),u.getMetallicFactor()!==1&&(a.pbrMetallicRoughness.metallicFactor=u.getMetallicFactor()),u.getBaseColorTexture()){const h=u.getBaseColorTexture(),l=u.getBaseColorTextureInfo();a.pbrMetallicRoughness.baseColorTexture=o.createTextureInfoDef(h,l)}if(u.getEmissiveTexture()){const h=u.getEmissiveTexture(),l=u.getEmissiveTextureInfo();a.emissiveTexture=o.createTextureInfoDef(h,l)}if(u.getNormalTexture()){const h=u.getNormalTexture(),l=u.getNormalTextureInfo(),g=o.createTextureInfoDef(h,l);u.getNormalScale()!==1&&(g.scale=u.getNormalScale()),a.normalTexture=g}if(u.getOcclusionTexture()){const h=u.getOcclusionTexture(),l=u.getOcclusionTextureInfo(),g=o.createTextureInfoDef(h,l);u.getOcclusionStrength()!==1&&(g.strength=u.getOcclusionStrength()),a.occlusionTexture=g}if(u.getMetallicRoughnessTexture()){const h=u.getMetallicRoughnessTexture(),l=u.getMetallicRoughnessTextureInfo();a.pbrMetallicRoughness.metallicRoughnessTexture=o.createTextureInfoDef(h,l)}return o.materialIndexMap.set(u,E),a}),n.meshes=s.listMeshes().map((u,E)=>{const a=o.createPropertyDef(u);let h=null;return a.primitives=u.listPrimitives().map(l=>{const g={attributes:{}};g.mode=l.getMode();const m=l.getMaterial();m&&(g.material=o.materialIndexMap.get(m)),Object.keys(l.getExtras()).length&&(g.extras=l.getExtras());const w=l.getIndices();w&&(g.indices=o.accessorIndexMap.get(w));for(const M of l.listSemantics())g.attributes[M]=o.accessorIndexMap.get(l.getAttribute(M));for(const M of l.listTargets()){const S={};for(const P of M.listSemantics())S[P]=o.accessorIndexMap.get(M.getAttribute(P));g.targets=g.targets||[],g.targets.push(S)}return l.listTargets().length&&!h&&(h=l.listTargets().map(M=>M.getName())),g}),u.getWeights().length&&(a.weights=u.getWeights()),h&&(a.extras=a.extras||{},a.extras.targetNames=h),o.meshIndexMap.set(u,E),a}),n.cameras=s.listCameras().map((u,E)=>{const a=o.createPropertyDef(u);if(a.type=u.getType(),a.type===Te.Type.PERSPECTIVE){a.perspective={znear:u.getZNear(),zfar:u.getZFar(),yfov:u.getYFov()};const h=u.getAspectRatio();h!==null&&(a.perspective.aspectRatio=h)}else a.orthographic={znear:u.getZNear(),zfar:u.getZFar(),xmag:u.getXMag(),ymag:u.getYMag()};return o.cameraIndexMap.set(u,E),a}),n.nodes=s.listNodes().map((u,E)=>{const a=o.createPropertyDef(u);return U.eq(u.getTranslation(),[0,0,0])||(a.translation=u.getTranslation()),U.eq(u.getRotation(),[0,0,0,1])||(a.rotation=u.getRotation()),U.eq(u.getScale(),[1,1,1])||(a.scale=u.getScale()),u.getWeights().length&&(a.weights=u.getWeights()),o.nodeIndexMap.set(u,E),a}),n.skins=s.listSkins().map((u,E)=>{const a=o.createPropertyDef(u),h=u.getInverseBindMatrices();h&&(a.inverseBindMatrices=o.accessorIndexMap.get(h));const l=u.getSkeleton();return l&&(a.skeleton=o.nodeIndexMap.get(l)),a.joints=u.listJoints().map(g=>o.nodeIndexMap.get(g)),o.skinIndexMap.set(u,E),a}),s.listNodes().forEach((u,E)=>{const a=n.nodes[E],h=u.getMesh();h&&(a.mesh=o.meshIndexMap.get(h));const l=u.getCamera();l&&(a.camera=o.cameraIndexMap.get(l));const g=u.getSkin();g&&(a.skin=o.skinIndexMap.get(g)),u.listChildren().length>0&&(a.children=u.listChildren().map(m=>o.nodeIndexMap.get(m)))}),n.animations=s.listAnimations().map((u,E)=>{const a=o.createPropertyDef(u),h=new Map;return a.samplers=u.listSamplers().map((l,g)=>{const m=o.createPropertyDef(l);return m.input=o.accessorIndexMap.get(l.getInput()),m.output=o.accessorIndexMap.get(l.getOutput()),m.interpolation=l.getInterpolation(),h.set(l,g),m}),a.channels=u.listChannels().map(l=>{const g=o.createPropertyDef(l);return g.sampler=h.get(l.getSampler()),g.target={node:o.nodeIndexMap.get(l.getTargetNode()),path:l.getTargetPath()},g}),o.animationIndexMap.set(u,E),a}),n.scenes=s.listScenes().map((u,E)=>{const a=o.createPropertyDef(u);return a.nodes=u.listChildren().map(h=>o.nodeIndexMap.get(h)),o.sceneIndexMap.set(u,E),a});const I=s.getDefaultScene();return I&&(n.scene=s.listScenes().indexOf(I)),n.extensionsUsed=p.map(u=>u.extensionName),n.extensionsRequired=d.map(u=>u.extensionName),p.forEach(u=>u.write(o)),function(u){const E=[];for(const a in u){const h=u[a];(Array.isArray(h)&&h.length===0||h===null||h===""||h&&typeof h=="object"&&Object.keys(h).length===0)&&E.push(a)}for(const a of E)delete u[a]}(n),i}};var Ve;(function(r){r[r.JSON=1313821514]="JSON",r[r.BIN=5130562]="BIN"})(Ve||(Ve={}));class hs{constructor(){this.M=k.DEFAULT_INSTANCE,this.h=new Set,this.F={},this.U=De.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this.M=e,this}registerExtensions(e){for(const t of e)this.h.add(t),t.register();return this}registerDependencies(e){return Object.assign(this.F,e),this}setVertexLayout(e){return this.U=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const s=ft(t)?this.P(t):{json:JSON.parse(O.decodeText(t)),resources:{}};return await this.L(s,this.dirname(e)),this.j(s),s}async readJSON(e){return e=this.D(e),this.j(e),os.read(e,{extensions:Array.from(this.h),dependencies:this.F,logger:this.M})}async binaryToJSON(e){const t=this.P(O.assertView(e));this.j(t);const s=t.json;if(s.buffers&&s.buffers.some(n=>function(i,o){return o.uri!==void 0&&!(o.uri in i.resources)}(t,n)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(s.images&&s.images.some(n=>function(i,o){return o.uri!==void 0&&!(o.uri in i.resources)&&o.bufferView===void 0}(t,n)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(O.assertView(e)))}async writeJSON(e,t={}){if(t.format===te.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 0–1 buffers.");return fs.write(e,{format:t.format||te.GLTF,basename:t.basename||"",logger:this.M,vertexLayout:this.U,dependencies:G({},this.F),extensions:Array.from(this.h)})}async writeBinary(e){const{json:t,resources:s}=await this.writeJSON(e,{format:te.GLB}),n=new Uint32Array([1179937895,2,12]),i=JSON.stringify(t),o=O.pad(O.encodeText(i),32),c=O.toView(new Uint32Array([o.byteLength,1313821514])),f=O.concat([c,o]);n[n.length-1]+=f.byteLength;const p=Object.values(s)[0];if(!p||!p.byteLength)return O.concat([O.toView(n),f]);const d=O.pad(p,0),T=O.toView(new Uint32Array([d.byteLength,5130562])),y=O.concat([T,d]);return n[n.length-1]+=y.byteLength,O.concat([O.toView(n),f,y])}async L(e,t){var s=this;const n=[...e.json.images||[],...e.json.buffers||[]].map(async function(i){const o=i.uri;if(!o||o.match(/data:/))return Promise.resolve();e.resources[o]=await s.readURI(s.resolve(t,o),"view"),s.lastReadBytes+=e.resources[o].byteLength});await Promise.all(n)}j(e){function t(s){if(s.uri){if(s.uri in e.resources)O.assertView(e.resources[s.uri]);else if(s.uri.match(/data:/)){const n=`__${ss()}.${ue.extension(s.uri)}`;e.resources[n]=O.createBufferFromDataURI(s.uri),s.uri=n}}}(e.json.images||[]).forEach(s=>{if(s.bufferView===void 0&&s.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(s)}),(e.json.buffers||[]).forEach(t)}D(e){const{images:t,buffers:s}=e.json;return e={json:G({},e.json),resources:G({},e.resources)},t&&(e.json.images=t.map(n=>G({},n))),s&&(e.json.buffers=s.map(n=>G({},n))),e}P(e){if(!ft(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==Ve.JSON)throw new Error("Missing required GLB JSON chunk.");const s=t[0],n=O.decodeText(O.toView(e,20,s)),i=JSON.parse(n),o=20+s;if(e.byteLength<=o)return{json:i,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+o,2);if(c[1]!==Ve.BIN)throw new Error("Expected GLB BIN in second chunk.");const f=O.toView(e,o+8,c[0]);return{json:i,resources:{[Le]:f}}}}function ft(r){if(r.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(r.buffer,r.byteOffset,3);return e[0]===1179937895&&e[1]===2}class ks extends hs{constructor(e=de.DEFAULT_INIT){super(),this.k=void 0,this.k=e}async readURI(e,t){const s=await fetch(e,this.k);switch(t){case"view":return new Uint8Array(await s.arrayBuffer());case"text":return s.text()}}resolve(e,t){return de.resolve(e,t)}dirname(e){return de.dirname(e)}}function _e(){return _e=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(r[s]=t[s])}return r},_e.apply(this,arguments)}function Lt(r,e){return Object.defineProperty(e,"name",{value:r}),e}function ls(r){const e=[];for(const t of r.listAttributes())e.push(t);for(const t of r.listTargets())for(const s of t.listAttributes())e.push(s);return Array.from(new Set(e))}function gs(r,e=r){const t=e<=65534?new Uint16Array(r):new Uint32Array(r);for(let s=0;s<t.length;s++)t[s]=s;return t}function ps(r){const e=new Set;let t,s=r;for(;t=s.getParentNode();){if(e.has(t))throw new Error("Circular dependency in scene graph.");e.add(t),s=t}return s.listParents().filter(n=>n instanceof $e)}function ds(r){const e=ps(r),t=r.getParentNode();if(!t)return r;r.setMatrix(r.getWorldMatrix()),t.removeChild(r);for(const s of e)s.addChild(r);return r}var fe=typeof Float32Array<"u"?Float32Array:Array;function ms(r,e,t){var s=e[0],n=e[1],i=e[2],o=e[3],c=e[4],f=e[5],p=e[6],d=e[7],T=e[8],y=e[9],A=e[10],R=e[11],I=e[12],u=e[13],E=e[14],a=e[15],h=t[0],l=t[1],g=t[2],m=t[3];return r[0]=h*s+l*c+g*T+m*I,r[1]=h*n+l*f+g*y+m*u,r[2]=h*i+l*p+g*A+m*E,r[3]=h*o+l*d+g*R+m*a,r[4]=(h=t[4])*s+(l=t[5])*c+(g=t[6])*T+(m=t[7])*I,r[5]=h*n+l*f+g*y+m*u,r[6]=h*i+l*p+g*A+m*E,r[7]=h*o+l*d+g*R+m*a,r[8]=(h=t[8])*s+(l=t[9])*c+(g=t[10])*T+(m=t[11])*I,r[9]=h*n+l*f+g*y+m*u,r[10]=h*i+l*p+g*A+m*E,r[11]=h*o+l*d+g*R+m*a,r[12]=(h=t[12])*s+(l=t[13])*c+(g=t[14])*T+(m=t[15])*I,r[13]=h*n+l*f+g*y+m*u,r[14]=h*i+l*p+g*A+m*E,r[15]=h*o+l*d+g*R+m*a,r}function We(){var r=new fe(3);return fe!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Dt(r,e){var t=e[0],s=e[1],n=e[2],i=t*t+s*s+n*n;return i>0&&(i=1/Math.sqrt(i)),r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function Es(r,e,t){var s=e[0],n=e[1],i=e[2],o=t[3]*s+t[7]*n+t[11]*i+t[15];return r[0]=(t[0]*s+t[4]*n+t[8]*i+t[12])/(o=o||1),r[1]=(t[1]*s+t[5]*n+t[9]*i+t[13])/o,r[2]=(t[2]*s+t[6]*n+t[10]*i+t[14])/o,r}function ys(r,e,t){var s=e[0],n=e[1],i=e[2];return r[0]=s*t[0]+n*t[3]+i*t[6],r[1]=s*t[1]+n*t[4]+i*t[7],r[2]=s*t[2]+n*t[5]+i*t[8],r}function Ut(){var r=new fe(4);return fe!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Ts(r,e,t=new Set){var s;const n=r.getAttribute("POSITION"),i=((s=r.getIndices())==null?void 0:s.getArray())||gs(n.getCount());n&&ht(e,n,i,new Set(t));const o=r.getAttribute("NORMAL");o&&lt(e,o,i,new Set(t));const c=r.getAttribute("TANGENT");c&&gt(e,c,i,new Set(t));for(const f of r.listTargets()){const p=f.getAttribute("POSITION");p&&ht(e,p,i,new Set(t));const d=f.getAttribute("NORMAL");d&&lt(e,d,i,new Set(t));const T=f.getAttribute("TANGENT");T&&gt(e,T,i,new Set(t))}for(let f=0;f<i.length;f++)t.add(i[f])}function ht(r,e,t,s){const n=new Float32Array(3*e.getCount()),i=e.getElementSize();for(let c=0,f=[],p=e.getCount();c<p;c++)n.set(e.getElement(c,f),c*i);const o=We();for(let c=0;c<t.length;c++){const f=t[c];s.has(f)||(e.getElement(f,o),Es(o,o,r),n.set(o,3*f),s.add(f))}e.setArray(n).setNormalized(!1)}function lt(r,e,t,s){const n=(i=new fe(9),fe!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i);var i;(function(c,f){c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=f[4],c[4]=f[5],c[5]=f[6],c[6]=f[8],c[7]=f[9],c[8]=f[10]})(n,r),function(c,f){var p=f[0],d=f[1],T=f[2],y=f[3],A=f[4],R=f[5],I=f[6],u=f[7],E=f[8],a=E*A-R*u,h=-E*y+R*I,l=u*y-A*I,g=p*a+d*h+T*l;g&&(c[0]=a*(g=1/g),c[1]=(-E*d+T*u)*g,c[2]=(R*d-T*A)*g,c[3]=h*g,c[4]=(E*p-T*I)*g,c[5]=(-R*p+T*y)*g,c[6]=l*g,c[7]=(-u*p+d*I)*g,c[8]=(A*p-d*y)*g)}(n,n),function(c,f){if(c===f){var p=f[1],d=f[2],T=f[5];c[1]=f[3],c[2]=f[6],c[3]=p,c[5]=f[7],c[6]=d,c[7]=T}else c[0]=f[0],c[1]=f[3],c[2]=f[6],c[3]=f[1],c[4]=f[4],c[5]=f[7],c[6]=f[2],c[7]=f[5],c[8]=f[8]}(n,n);const o=We();for(let c=0;c<t.length;c++){const f=t[c];s.has(f)||(e.getElement(f,o),ys(o,o,n),Dt(o,o),e.setElement(f,o),s.add(f))}}function gt(r,e,t,s){const n=We(),i=Ut();for(let o=0;o<t.length;o++){const c=t[o];if(s.has(c))continue;e.getElement(c,i);const[f,p,d]=i;n[0]=r[0]*f+r[4]*p+r[8]*d,n[1]=r[1]*f+r[5]*p+r[9]*d,n[2]=r[2]*f+r[6]*p+r[10]*d,Dt(n,n),i[0]=n[0],i[1]=n[1],i[2]=n[2],e.setElement(c,i),s.add(c)}}function Rs(r,e,t=!1,s){for(const n of r.listPrimitives())if(n.listParents().some(i=>i.propertyType===x.MESH&&i!==r)){const i=n.clone();r.swap(n,i);for(const o of i.listTargets()){const c=o.clone();i.swap(o,c)}}if(!t){const n=new Set([...r.listPrimitives(),...r.listPrimitives().flatMap(o=>o.listTargets())]),i=new Map;for(const o of r.listPrimitives())for(const c of ls(o))c.listParents().some(f=>(f instanceof xe||f instanceof Nt)&&!n.has(f))&&!i.has(c)&&i.set(c,c.clone());for(const o of n)for(const[c,f]of i)o.swap(c,f)}s=s||new Set;for(const n of r.listPrimitives())Ts(n,e,s)}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)}),We(),Ut();const pt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function $s(r){const e=r.getMesh(),t=r.getMatrix();e&&!U.eq(t,pt)&&Rs(e,t);for(const s of r.listChildren()){const n=s.getMatrix();ms(n,n,t),s.setMatrix(n)}return r.setMatrix(pt)}x.ACCESSOR,x.MESH,x.TEXTURE,x.MATERIAL,x.SKIN;function xs(r){const e=r.getGraph(),t=new Set;for(const s of e.listParentEdges(r)){const n=s.getParent(),i=s.getName()+"Info";for(const o of e.listChildEdges(n)){const c=o.getChild();c instanceof X&&o.getName()===i&&t.add(c)}}return Array.from(t)}function As(r){const e=r.getGraph(),t=new Set,s=new Set;return function n(i){for(const o of e.listChildren(i))if(!t.has(o))if(t.add(o),o instanceof Ee)for(const c of xs(o))s.add(c);else o instanceof Re&&n(o)}(r),Array.from(s)}const Oe="prune",dt={propertyTypes:[x.NODE,x.SKIN,x.MESH,x.CAMERA,x.PRIMITIVE,x.PRIMITIVE_TARGET,x.ANIMATION,x.MATERIAL,x.TEXTURE,x.ACCESSOR,x.BUFFER],keepLeaves:!1,keepAttributes:!0};function Is(r=dt){const e=_e({},dt,r),t=new Set(e.propertyTypes);return Lt(Oe,s=>{const n=s.getLogger(),i=s.getRoot(),o=s.getGraph(),c={};if(t.has(x.MESH))for(const y of i.listMeshes())y.listPrimitives().length>0||(y.dispose(),T(y));if(t.has(x.NODE)&&!e.keepLeaves&&i.listScenes().forEach(function y(A){if(A.listChildren().forEach(y),A instanceof $e)return;const R=o.listParentEdges(A).some(I=>{const u=I.getParent().propertyType;return u!==x.ROOT&&u!==x.SCENE&&u!==x.NODE});o.listChildren(A).length!==0||R||(A.dispose(),T(A))}),t.has(x.NODE)&&i.listNodes().forEach(f),t.has(x.SKIN)&&i.listSkins().forEach(f),t.has(x.MESH)&&i.listMeshes().forEach(f),t.has(x.CAMERA)&&i.listCameras().forEach(f),t.has(x.PRIMITIVE)&&p(o,x.PRIMITIVE),t.has(x.PRIMITIVE_TARGET)&&p(o,x.PRIMITIVE_TARGET),!e.keepAttributes&&t.has(x.ACCESSOR)){const y=new Map;for(const A of i.listMeshes())for(const R of A.listPrimitives()){const I=R.getMaterial(),u=bs(R,Bt(s,I));d(R,u),R.listTargets().forEach(E=>d(E,u)),I&&(y.has(I)?y.get(I).add(R):y.set(I,new Set([R])))}for(const[A,R]of y)ws(A,Array.from(R))}if(t.has(x.ANIMATION))for(const y of i.listAnimations()){for(const A of y.listChannels())A.getTargetNode()||(A.dispose(),T(A));if(y.listChannels().length)y.listSamplers().forEach(f);else{const A=y.listSamplers();f(y),A.forEach(f)}}if(t.has(x.MATERIAL)&&i.listMaterials().forEach(f),t.has(x.TEXTURE)&&i.listTextures().forEach(f),t.has(x.ACCESSOR)&&i.listAccessors().forEach(f),t.has(x.BUFFER)&&i.listBuffers().forEach(f),Object.keys(c).length){const y=Object.keys(c).map(A=>`${A} (${c[A]})`).join(", ");n.info(`${Oe}: Removed types... ${y}`)}else n.info(`${Oe}: No unused properties found.`);function f(y){y.listParents().filter(A=>!(A instanceof Ot||A instanceof ke)).length||(y.dispose(),T(y))}function p(y,A){y.listEdges().map(R=>R.getParent()).filter(R=>R.propertyType===A).forEach(f)}function d(y,A){for(const R of A)y.setAttribute(R,null)}function T(y){c[y.propertyType]=c[y.propertyType]||0,c[y.propertyType]++}n.debug(`${Oe}: Complete.`)})}function bs(r,e){const t=[];for(const s of r.listSemantics())s!=="TANGENT"||e.has(s)?(s.startsWith("TEXCOORD_")&&!e.has(s)||s.startsWith("COLOR_")&&s!=="COLOR_0")&&t.push(s):t.push(s);return t}function Bt(r,e,t=new Set){if(!e)return t;const s=r.getGraph().listChildEdges(e),n=new Set;for(const i of s)i.getChild()instanceof Ee&&n.add(i.getName());for(const i of s){const o=i.getName(),c=i.getChild();c instanceof X&&n.has(o.replace(/Info$/,""))&&t.add(`TEXCOORD_${c.getTexCoord()}`),c instanceof Ee&&o.match(/normalTexture/i)&&t.add("TANGENT"),c instanceof Re&&Bt(r,c,t)}return t}function ws(r,e){const t=As(r),s=new Set(t.map(f=>f.getTexCoord())),n=Array.from(s).sort(),i=new Map(n.map((f,p)=>[f,p])),o=new Map(n.map((f,p)=>[`TEXCOORD_${f}`,`TEXCOORD_${p}`]));for(const f of t){const p=f.getTexCoord();f.setTexCoord(i.get(p))}for(const f of e){const p=f.listSemantics().filter(d=>d.startsWith("TEXCOORD_")).sort();c(f,p),f.listTargets().forEach(d=>c(d,p))}function c(f,p){for(const d of p){const T=f.getAttribute(d);if(!T)continue;const y=o.get(d);y!==d&&(f.setAttribute(y,T),f.setAttribute(d,null))}}}const qe="flatten",mt={};function Ws(r=mt){return _e({},mt,r),Lt(qe,async e=>{const t=e.getRoot(),s=e.getLogger(),n=new Set;for(const f of t.listSkins())for(const p of f.listJoints())n.add(p);const i=new Set;for(const f of t.listAnimations())for(const p of f.listChannels()){const d=p.getTargetNode();d&&i.add(d)}const o=new Set,c=new Set;for(const f of t.listScenes())f.traverse(p=>{const d=p.getParentNode();d&&((n.has(d)||o.has(d))&&o.add(p),(i.has(d)||c.has(d))&&c.add(p))});for(const f of t.listScenes())f.traverse(p=>{i.has(p)||o.has(p)||c.has(p)||ds(p)});i.size&&s.debug(`${qe}: Flattening node hierarchies with TRS animation not yet supported.`),await e.transform(Is({propertyTypes:[x.NODE],keepLeaves:!1})),s.debug(`${qe}: Complete.`)})}ke.TargetPath;var Et;function he(r,e,t){for(let s=0,n=t.length;s<n;s++)t[s]=r[e*n+s];return t}function yt(r,e,t){for(let s=0,n=t.length;s<n;s++)r[e*n+s]=t[s]}function Pe(r,e,t=0){if(r.length!==e.length)return!1;for(let s=0;s<r.length;s++)if(Math.abs(r[s]-e[s])>t)return!1;return!0}function Ms(r,e,t){return r*(1-t)+e*t}function Ss(r,e,t,s){for(let n=0;n<e.length;n++)r[n]=Ms(e[n],t[n],s);return r}function vs(r,e,t,s){let n,i,o,c,f,p=e[0],d=e[1],T=e[2],y=e[3],A=t[0],R=t[1],I=t[2],u=t[3];return i=p*A+d*R+T*I+y*u,i<0&&(i=-i,A=-A,R=-R,I=-I,u=-u),1-i>1e-6?(n=Math.acos(i),o=Math.sin(n),c=Math.sin((1-s)*n)/o,f=Math.sin(s*n)/o):(c=1-s,f=s),r[0]=c*p+f*A,r[1]=c*d+f*R,r[2]=c*T+f*I,r[3]=c*y+f*u,r}function Tt(r,e){const t=function(s,n){return s[0]*n[0]+s[1]*n[1]+s[2]*n[2]+s[3]*n[3]}(r,e);return Math.acos(2*t*t-1)}(function(r){r[r.STEP=0]="STEP",r[r.LERP=1]="LERP",r[r.SLERP=2]="SLERP"})(Et||(Et={}));Promise.resolve();var je;(function(r){r.LANCZOS3="lanczos3",r.LANCZOS2="lanczos2"})(je||(je={}));je.LANCZOS3;je.LANCZOS3;const H="EXT_manifold";class Ns extends Re{static EXTENSION_NAME=H;init(){this.EXTENSION_NAME=H,this.propertyType="ManifoldPrimitive",this.parentTypes=[x.MESH]}getDefaults(){return Object.assign(super.getDefaults(),{manifoldPrimitive:null,mergeIndices:null,mergeValues:null})}getMergeIndices(){return this.getRef("mergeIndices")}getMergeValues(){return this.getRef("mergeValues")}setMerge(e,t){if(e.getCount()!==t.getCount())throw new Error("merge vectors must be the same length.");return this.setRef("mergeIndices",e),this.setRef("mergeValues",t)}getRunIndex(){return this.get("runIndex")}setRunIndex(e){return this.set("runIndex",e)}setIndices(e){return this.setRef("indices",e)}getIndices(){return this.getRef("indices")}}class Vt extends Ft{extensionName=H;static EXTENSION_NAME=H;createManifoldPrimitive(){return new Ns(this.document.getGraph())}read(e){const{json:t}=e.jsonDoc;return(t.meshes||[]).forEach((n,i)=>{if(!n.extensions||!n.extensions[H])return;const o=e.meshes[i],c=this.createManifoldPrimitive();o.setExtension(H,c);const f=n.extensions[H];if(f.manifoldPrimitive){let p=0;const d=[];d.push(p);for(const T of o.listPrimitives())p+=T.getIndices().getCount(),d.push(p);c.setRunIndex(d)}f.mergeIndices&&f.mergeValues&&c.setMerge(e.accessors[f.mergeIndices],e.accessors[f.mergeValues])}),this}write(e){const{json:t}=e.jsonDoc;return this.document.getRoot().listMeshes().forEach(s=>{const n=s.getExtension(H);if(!n)return;const i=e.meshIndexMap.get(s),o=t.meshes[i],c=n.getRunIndex(),f=c.length-1;if(f!==o.primitives.length)throw new Error("The number of primitives must be exactly one less than the length of runIndex.");const p=e.accessorIndexMap.get(n.getMergeIndices()),d=e.accessorIndexMap.get(n.getMergeValues()),T=t.accessors[p],y=t.accessors[d],A=o.primitives[0],R={indices:e.accessorIndexMap.get(n.getIndices()),mode:A.mode,attributes:{POSITION:A.attributes.POSITION}},I=t.accessors[R.indices];if(I){T&&y&&(I.sparse={count:T.count,indices:{bufferView:T.bufferView,byteOffset:T.byteOffset,componentType:T.componentType},values:{bufferView:y.bufferView,byteOffset:y.byteOffset}});for(let u=0;u<f;++u){const E=t.accessors[o.primitives[u].indices];E.bufferView=I.bufferView,E.byteOffset=I.byteOffset+4*c[u],E.count=c[u+1]-c[u]}o.extensions=o.extensions||{},o.extensions[H]={manifoldPrimitive:R,mergeIndices:p,mergeValues:d}}}),this}}const Ge={POSITION:{type:b.Type.VEC3,components:3},SKIP:{type:null,components:1},NORMAL:{type:b.Type.VEC3,components:3},TANGENT:{type:b.Type.VEC4,components:4},TEXCOORD_0:{type:b.Type.VEC2,components:2},TEXCOORD_1:{type:b.Type.VEC2,components:2},COLOR_0:{type:b.Type.VEC3,components:3},JOINTS_0:{type:b.Type.VEC4,components:4},WEIGHTS_0:{type:b.Type.VEC4,components:4}};function Ys(r){return r.registerExtensions([Vt])}function Rt(r,e,t){const n=r.getAttribute("POSITION").getCount(),i=[];let o=0;for(const c of t){if(c==="SKIP"){o+=Ge[c].components;continue}const f=r.getAttribute(c),p=f.getArray(),d=f.getElementSize();for(let T=0;T<n;++T)for(let y=0;y<d;++y)i[e*T+o+y]=p[T*d+y];o+=d}return i}function Xs(r,e,t){const s=r.listPrimitives();if(s.length===0)return{};if(e.length===0){const R=new Set;for(const I of s){const u=I.listSemantics();for(const E of u)R.add(E)}for(const I in Ge)R.has(I)&&(e.push(I),R.delete(I));for(const I of R.keys())e.push(I)}if(e.length<1||e[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');const n=e.map(R=>Ge[R].components).reduce((R,I)=>R+I),i=r.getExtension("EXT_manifold");let o=[],c=[];const f=[0],p=[],d=[];if(i!=null){o=Rt(s[0],n,e);for(const E of s)c=[...c,...E.getIndices().getArray()],f.push(c.length),t.push(E.getMaterial());const R=i.getMergeIndices()?.getArray()??[],I=i.getMergeValues()?.getArray()??[],u=new Map;for(const[E,a]of R.entries())u.set(c[a],I[E]);for(const[E,a]of u.entries())p.push(E),d.push(a)}else for(const R of s){const I=o.length/n;o=[...o,...Rt(R,n,e)],c=[...c,...R.getIndices().getArray().map(u=>u+I)],f.push(c.length),t.push(R.getMaterial())}const T=new Float32Array(o),y=new Uint32Array(c),A=new Uint32Array(f);return{numProp:n,triVerts:y,vertProperties:T,runIndex:A,mergeFromVert:p,mergeToVert:d}}function qs(r,e,t,s){r.getRoot().listBuffers().length===0&&r.createBuffer();const n=r.getRoot().listBuffers()[0],i=r.createExtension(Vt),o=r.createMesh(),c=e.runIndex.length-1;for(let a=0;a<c;++a){const h=r.createAccessor("indices").setBuffer(n).setType(b.Type.SCALAR).setArray(new Uint32Array),l=r.createPrimitive().setIndices(h),g=s[a];g&&l.setMaterial(g),o.addPrimitive(l)}if(t.length<1||t[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');const f=e.numVert,p=e.numProp;let d=0;for(const a of t){if(a==="SKIP"){++d;continue}const h=Ge[a];if(h==null)throw new Error(a+" is not a recognized attribute.");const l=h.components;if(d+l>p)throw new Error("Too many attribute channels.");const g=new Float32Array(l*f);for(let w=0;w<f;++w)for(let M=0;M<l;++M)g[l*w+M]=e.vertProperties[p*w+d+M];const m=r.createAccessor().setBuffer(n).setType(h.type).setArray(g);for(const w of o.listPrimitives())w.setAttribute(a,m);d+=l}const T=i.createManifoldPrimitive();o.setExtension("EXT_manifold",T);const y=r.createAccessor("indices").setBuffer(n).setType(b.Type.SCALAR).setArray(e.triVerts);T.setIndices(y),T.setRunIndex(e.runIndex);const A=[...Array(e.numVert).keys()];for(const[a,h]of e.mergeFromVert.entries())A[h]=e.mergeToVert[a];const R=[],I=[];for(const[a,h]of e.triVerts.entries()){const l=A[h];h!==l&&(R.push(a),I.push(l))}const u=r.createAccessor().setBuffer(n).setType(b.Type.SCALAR).setArray(new Uint32Array(R)),E=r.createAccessor().setBuffer(n).setType(b.Type.SCALAR).setArray(new Uint32Array(I));return T.setMerge(u,E),o}function Hs(r){if(!r)return;const e=r.listPrimitives();for(const t of e){t.getIndices()?.dispose();for(const s of t.listAttributes())s.dispose()}r.dispose()}export{ks as D,O as E,se as I,b as K,we as M,U as P,re as S,Ft as T,ke as X,Cs as a,Ys as b,Le as c,Je as d,Ws as e,$s as f,Hs as g,x as h,xe as l,X as n,Xs as r,Re as s,ye as t,Pt as v,qs as w,Ot as y,Is as z};
