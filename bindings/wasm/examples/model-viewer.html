<!doctype html>
<html>
<meta name="viewport">

<body>
  This example demonstrates feeding Manifold's output into <a href="https://modelviewer.dev/">&lt;model-viewer&gt;</a>
  via the three.js GLTFExporter. The most basic three.js example is <a href="index.html">here</a>.<br />
  <select>
    <option value="Difference" selected>Difference</option>
    <option value="Intersection">Intersection</option>
    <option value="Union">Union</option>
  </select>
  <model-viewer camera-controls shadow-intensity="1" alt="Output of mesh Boolean operation"></model-viewer>
</body>

<style>
  model-viewer {
    width: 600px;
    height: 600px;
  }
</style>

<script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
<script src="https://unpkg.com/three@0.144.0/examples/js/utils/BufferGeometryUtils.js"></script>
<script src="https://unpkg.com/three@0.144.0/examples/js/exporters/GLTFExporter.js"></script>
<script>
  var Module = {
    onRuntimeInitialized: function () {
      const mesh = new THREE.Mesh(undefined, new THREE.MeshStandardMaterial({
        color: 'yellow',
        metalness: 1,
        roughness: 0.2
      }));

      const geometry_1 = simplify(new THREE.BoxGeometry(0.2, 0.2, 0.2));
      const geometry_2 = simplify(new THREE.IcosahedronGeometry(0.16));

      const manifold_1 = new Module.Manifold(geometry2mesh(geometry_1));
      const manifold_2 = new Module.Manifold(geometry2mesh(geometry_2));

      const csg = function (operation) {
        mesh.geometry?.dispose();
        mesh.geometry = mesh2geometry(
          Module[operation](manifold_1, manifold_2).GetMesh()
        );
        push2MV(mesh);
      };

      document.querySelector('select').onchange = function (event) {
        csg(event.target.value);
      };

      csg('Difference');
    }
  };

  const mv = document.querySelector('model-viewer');
  let objectURL = null;
  const exporter = new THREE.GLTFExporter();

  function push2MV(mesh) {
    exporter.parse(
      mesh,
      (gltf) => {
        const blob = new Blob([gltf], { type: 'application/octet-stream' });
        URL.revokeObjectURL(objectURL);
        objectURL = URL.createObjectURL(blob);
        mv.src = objectURL;
      },
      () => console.log('GLTF export failed!'),
      { binary: true }
    );
  }

  // functions to convert between three.js and wasm
  function geometry2mesh(geometry) {
    const mesh = {
      vertPos: new Module.Vector_vec3(),
      vertNormal: new Module.Vector_vec3(),
      triVerts: new Module.Vector_ivec3(),
      halfedgeTangent: new Module.Vector_vec4()
    };
    const temp = new THREE.Vector3();
    const p = geometry.attributes.position;
    // const n = geometry.attributes.normal;
    const x = geometry.index;
    for (let i = 0; i < p.count; i++) {
      temp.fromBufferAttribute(p, i);
      mesh.vertPos.push_back(temp);
      // temp.fromBufferAttribute(n, i);
      // mesh.vertNormal.push_back(temp);
    }
    for (let i = 0; i < x.count; i += 3) {
      mesh.triVerts.push_back(x.array.subarray(i, i + 3));
    }
    return mesh;
  }

  function mesh2geometry(mesh) {
    const geometry = new THREE.BufferGeometry();
    const p = [], n = [], x = [];
    let i, s, v;
    for (i = 0, s = mesh.vertPos.size(); i < s; i++) {
      v = mesh.vertPos.get(i);
      p.push(v.x, v.y, v.z);
      // v = mesh.vertNormal.get(i);
      // n.push(v.x, v.y, v.z);
    }
    for (i = 0, s = mesh.triVerts.size(); i < s; i++) {
      v = mesh.triVerts.get(i);
      x.push(v[0], v[1], v[2]);
    }
    geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(p), 3));
    // geometry.setAttribute('normal', new THREE.BufferAttribute(new Float32Array(n), 3));
    geometry.setIndex(new THREE.BufferAttribute(new Uint8Array(x), 1));
    return geometry;
  }

  // most of three.js geometries arent manifolds, so...
  function simplify(geometry) {
    delete geometry.attributes.normal;
    delete geometry.attributes.uv;
    const simplified = THREE.BufferGeometryUtils.mergeVertices(geometry);
    simplified.computeVertexNormals();
    return simplified;
  }
</script>
<script src="manifold.js"></script>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

</html>